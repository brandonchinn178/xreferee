name: Release
on: workflow_dispatch

jobs:
  build:
    strategy:
      matrix:
        include:
          # https://github.com/actions/runner-images?tab=readme-ov-file#available-images
          # https://github.blog/changelog/2025-01-16-linux-arm64-hosted-runners-now-available-for-free-in-public-repositories-public-preview/
          -
            target: linux-x86_64
            runner: ubuntu-24.04
          -
            target: linux-arm64
            runner: ubuntu-24.04-arm
          -
            target: osx-x86_64
            runner: macos-15-intel
          -
            target: osx-arm64
            runner: macos-15
    uses: ./.github/workflows/build.yml
    with:
      target: ${{ matrix.target }}
      runner: ${{ matrix.runner }}

  release:
    runs-on: ubuntu-latest
    needs:
      - build

    env:
      VERSION: ${{ needs.build.outputs.version }}

    steps:
      -
        uses: actions/checkout@v5
      -
        uses: actions/download-artifact@v7
        with:
          path: ./.release/
          pattern: xreferee-binary-*
          merge-multiple: true
      -
        name: Generate release notes
        run:
          scripts/release_notes.py generate
            --release-version ${VERSION}
            --bin linux-x86_64 .release/xreferee-${VERSION}-linux-x86_64
            --bin linux-aarch64 .release/xreferee-${VERSION}-linux-arm64
            --bin macos-x86_64 .release/xreferee-${VERSION}-osx-x86_64
            --bin macos-aarch64 .release/xreferee-${VERSION}-osx-arm64
            | tee .release/release-notes.md

      -
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          body_path: .release/release-notes.md
          draft: true
          target_commitish: ${{ github.sha }}
          files: |
            .release/xreferee-${{ env.VERSION }}-linux-x86_64
            .release/xreferee-${{ env.VERSION }}-linux-arm64
            .release/xreferee-${{ env.VERSION }}-osx-x86_64
            .release/xreferee-${{ env.VERSION }}-osx-arm64
          fail_on_unmatched_files: true
